/*! marionette-formview - v1.0.1 - 2014-08-08 */
!function(a,b){"use strict";"function"==typeof define&&define.amd?define(["backbone","marionette","jquery","underscore"],b):a.Marionette.FormView=b(a.Backbone,a.Marionette,a.jQuery,a._)}(this,function(a,b,c,d){"use strict";var e=b.FormView=b.ItemView.extend({className:"formView",rules:{},fields:{},initialize:function(b){if(b=b||{},!this.fields)throw new Error("Fields Must Be Provided");this.model=b.model||this.model,this.model||(this.model=new a.Model),this.listenTo(this.model,"change",this.changeFieldVal,this),this.data=b.data||this.data,this.data&&this.model.set(this.data),this.template=b.template||this.template,this.template||this.runInitializers(),this.on("item:rendered",this.runInitializers,this),this.on("render",this.runInitializers,this)},changeFieldVal:function(a,b){if(!d.isEmpty(b)&&b.changes){var c=Object.keys(b.changes);this.inputVal(c,this.model.get(c))}else b.unset&&d(this.fields).each(function(a,b){var c=this.$('[data-field="'+b+'"]');this.inputVal(c,this.model.get(b))},this)},populateFields:function(){d(this.fields).each(function(a,b){var c=this.$('[data-field="'+b+'"]');this.inputVal(c,this.model.get(b)),a.autoFocus&&c.focus()},this)},serializeFormData:function(){var a={},b=this;return d(this.fields).each(function(c,d){a[d]=b.inputVal(d)}),a},beforeFormSubmit:function(a){var b=this.validate(),c=d.isEmpty(b);return c?d.isFunction(this.onSubmit)?this.onSubmit.apply(this,[a]):void 0:(d.isFunction(this.onSubmitFail)&&this.onSubmitFail.apply(this,[b]),a.stopImmediatePropagation(),!1)},onFieldEvent:function(a){this.handleFieldEvent(a,a.type)},handleFieldEvent:function(a,b){var e=a.target||a.srcElement,f=c(e).attr("data-field"),g=this.fields[f],h=!0;if(g.validateOn){if(g.validateOn===b){var i=this.validateField(f),h=d.isEmpty(i);!h&&d.isFunction(this.onValidationFail)&&this.onValidationFail(i),h&&(this.model.set(f,c(e).val()),d.isFunction(this.onValidationOk)&&this.onValidationOk(f))}}else this.model.set(f,c(e).val());return h},validate:function(){var a={},b=d(this.fields).keys();return d(b).each(function(b){var c=this.validateField(b);d.isEmpty(c)||(a[b]=c)},this),a},validateField:function(a){var b=this.fields[a],c=b&&b.validations?b.validations:{},e=[],f=b.allowEmpty,g=!0,h=this.inputVal(a);if(f&&""==h);else{if(b.required){g=this.validateRule(h,"required");var i="string"==typeof b.required?b.required:"This field is required";g||e.push(i)}if(g&&c&&d.each(c,function(a,b){g=this.validateRule(h,b),g||e.push(a)},this),!d.isEmpty(e)){var j={field:a,el:this.fields[a].el,error:e};return j}}},inputVal:function(a,b){var d=a.jquery?a:this.$('[data-field="'+a+'"]'),e=this,f="undefined"==typeof b?"get":"set";if("object"===d.data("fieldtype"))"get"===f&&(b={}),d.find("[data-property]").each(function(){var a=c(this),d=a.attr("data-property");"get"===f?b[d]=e.inputVal(a):b&&e.inputVal(a,b[d])});else if("array"===d.data("fieldtype"))"get"===f&&(b=[]),d.find("[data-index]").each(function(){var a=c(this),d=a.data("index");"get"===f?b[d]=e.inputVal(a):b&&e.inputVal(a,b[d])});else if(d.is("input")){var g=d.attr("type").toLowerCase();switch(g){case"radio":d.each(function(){var a=c(this);if("get"===f){if(a.is(":checked"))return b=a.val(),!1}else if(a.val()===b)return a.prop("checked",!0),!1});break;case"checkbox":"get"===f?b=d.is(":checked"):d.prop("checked",!!b);break;case"password":"get"===f?b=d.val():d.val(b);break;default:"get"===f?b=c.trim(d.val()):d.val(b)}}else"get"===f?b=c.trim(d.val()):d.val(b);return b},validateRule:function(a,b){var c;if(!b)throw new Error("Not passed a validation to test");return"required"===b?f.required(a):(-1!==b.indexOf(":")&&(c=b.split(":"),b=c.shift()),this.rules&&this.rules[b]?d(this.rules[b]).bind(this)(a):d(f.validate).bind(this)(b,a,c))},submit:function(){this.form.submit()},bindFormEvents:function(){var a=this.$el.is("form")?this.$el:this.$("form").first();this.form=a,this.$("input").blur(d(this.onFieldEvent).bind(this)).keyup(d(this.onFieldEvent).bind(this)).keydown(d(this.onFieldEvent).bind(this)).change(d(this.onFieldEvent).bind(this)),a.submit(d(this.beforeFormSubmit).bind(this))},runInitializers:function(){this.populateFields(),this.bindFormEvents(),d.isFunction(this.onReady)&&this.onReady()}}),f={regex:{email:/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i,alpha:/^[a-zA-Z]+$/,alphanum:/^[a-zA-Z0-9]+$/,url:new RegExp("^(?:(?:https?|ftp)://)(?:\\S+(?::\\S*)?@)?(?:(?!(?:10|127)(?:\\.\\d{1,3}){3})(?!(?:169\\.254|192\\.168)(?:\\.\\d{1,3}){2})(?!172\\.(?:1[6-9]|2\\d|3[0-1])(?:\\.\\d{1,3}){2})(?:[1-9]\\d?|1\\d\\d|2[01]\\d|22[0-3])(?:\\.(?:1?\\d{1,2}|2[0-4]\\d|25[0-5])){2}(?:\\.(?:[1-9]\\d?|1\\d\\d|2[0-4]\\d|25[0-4]))|(?:(?:[a-z\\u00a1-\\uffff0-9]-*)*[a-z\\u00a1-\\uffff0-9]+)(?:\\.(?:[a-z\\u00a1-\\uffff0-9]-*)*[a-z\\u00a1-\\uffff0-9]+)*(?:\\.(?:[a-z\\u00a1-\\uffff]{2,})))(?::\\d{2,5})?(?:/\\S*)?$","i")},validate:function(a,b,c){if(d.isFunction(f[a]))return d(f[a]).bind(this)(b,c);throw new Error("Validator does not exist : "+a)},matches:function(a,b){return a==this.inputVal(b)},min:function(a,b){return a.length<b?!1:!0},max:function(a,b){return a.length>b?!1:!0},numeric:function(a){return d.isNumber(a)},alpha:function(a){return f.regex.alpha.test(a)},alphanum:function(a){return f.regex.alphanum.test(a)},email:function(a){return f.regex.email.test(a)},url:function(a){return f.regex.url.test(a)},required:function(a){return a===!1||d.isNull(a)||d.isUndefined(a)||d.isString(a)&&0===a.length?!1:!0},"boolean":function(a){return d.isBoolean(a)}};return e});